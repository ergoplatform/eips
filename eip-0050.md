Sigma 6.0
=========

This EIP contains proposed changes for Ergo contractual layer, called Sigma. These changes are based on found issues 
in the current version of Sigma, as well as feedback got from users, i.e. Ergo ecosystem developers.


Activation 
----------

Rule 1011 should be replaced with another one, likely with the same rule but under different id.

Features Set 
------------

* *.validatePoW* method of *Header* type to validate Autolykos2 proof of work done on header 

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/958

PR #1: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/965 (Autolykos verification for a custom message)

status: costing missing, unpolished

PR #2: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/968 (Header.checkPow)

status: finished, under review


* implement conversion from Long-encoded nBits representation to BigInt (long.fromNBits method) and to nBits from BitInt (bigInt.toNBits method) 

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/675

PR #1: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/962 (nbits encoding)

status: costing missing, unpolished

PR #2: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/962 (nbits decoding)

status: costing missing, unpolished


* implement Boolean to Byte conversion (boolean.toByte method)

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/931
PR: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/932

status: unfinished

* implement BigIntModQ type (unsigned bigints mod Q, where Q is the order of secp256k1 group)

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/554

PR: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/997

status: unfinished


* support MethodCall encoding of Numeric methods

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/667

PR: (Numeric.toBigEndianBytes) https://github.com/ScorexFoundation/sigmastate-interpreter/pull/984

status: finished, under review


* Add Numeric.toBytes, .toBits

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/486

PR #1: (Numeric.toBigEndianBytes) https://github.com/ScorexFoundation/sigmastate-interpreter/pull/984

status: finished, under review


* Fix for downcasting BigInt to Long fails

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/877


* Lazy default evaluation for Option.getOrElse

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/906


* Implement Some and None constructors as global methods 

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/462


* Serialize Option[T] in DataSerializer

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/659

PR: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/990

status: finished, merged


* Add support for Header values (de)serialization in DataSerializer: 

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/969

PR: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/972

status: finished, under review


* GetVar(inputIndex, varId) variant for reading context variable from another input

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/983

* Implement binary serialization and deserialization for every type

issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/945


PR #1 (Global.deserializeTo): https://github.com/ScorexFoundation/sigmastate-interpreter/pull/979

status: costing missing, unpolished

PR #2 (Global.serialize): https://github.com/ScorexFoundation/sigmastate-interpreter/pull/989

status: finished, under review

PR #3 (Numeric.toBigEndianBytes) https://github.com/ScorexFoundation/sigmastate-interpreter/pull/984

status: finished, under review

* Fix SubstContants: serialize ErgoTree size
 
issue: https://github.com/ScorexFoundation/sigmastate-interpreter/issues/994
PR: https://github.com/ScorexFoundation/sigmastate-interpreter/pull/995

status: finished, under review


How to add a new method
-----------------------

Here are instructions on how to add a new method to existing types (as 6.0 is heavily about adding new methods).

Implementation:

* Checkout new branch based on "v6.0.0" branch

* Find appropriate type (e.g. *SBigInt*) to add a desirable method (e.g. *nbits*)

* Add method description there and add description handle to *getMethods()* in a class \*Methods corresponding to the type (*SBigIntMethods* in our example), add *method_eval* to be used via reflection in the compiler

* Add method implementation to corresponding type in *SigmaDsl.scala* 


* Add method evaluation to *ErgoTreeEvaluator* interface and its instantiation *CErgoTreeEvaluator*

* Add new method to reflection-related descriptions in *ReflectionData* (needed for compiler mostly?)

* Add pattern matching in GraphBuilding.scala to the compiler to get support for the new method in ErgoScript, e.g.
```
case Select(obj, SBigIntMethods.ToNBits.name, _) if obj.tpe == SBigInt && VersionContext.current.isV6SoftForkActivated =>
```

* Add new method to *SigmaDslUnit.scala* / *SigmaDslImpl.scala* (needed for compiler only)


Tests:


* Add compilation test in *TestingInterpreterSpecification*

* Add roundtrip test in *MethodCallSerializerSpecification*

* Add evaluation test (see "nbits evaluation" test)


Documentation:

* update `LangSpec.md`




How to add a new type
---------------------

[TODO: complete]
